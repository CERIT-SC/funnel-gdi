<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.21-DEV" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
  <title>AWS Batch &middot; Funnel</title>
  

  
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/poole.css">
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/darcula.css">
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/syntax.css">
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/theme.css">
  <link rel="stylesheet" href="https://ohsu-comp-bio.github.io/funnel/css/funnel.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://ohsu-comp-bio.github.io/funnel/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://ohsu-comp-bio.github.io/funnel/favicon.png">

  <script src="https://ohsu-comp-bio.github.io/funnel/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

</head>
<body>

  <div class="global-header">
    <div class="global-header-container">
      <div class="global-header-home">
        <a href="https://ohsu-comp-bio.github.io/funnel/"><h1>Funnel</h1></a>
      </div>
      <ul class="global-header-nav">
          <li><a href="https://ohsu-comp-bio.github.io/funnel/download/">Download</a></li>
          <li><a href="https://ohsu-comp-bio.github.io/funnel/docs/">Docs</a></li>
          <li><a href="https://github.com/ohsu-comp-bio/funnel">GitHub</a></li>
          <li><a href="https://gitter.im/ohsu-comp-bio/funnel">Chat</a></li>
        </ul>
      <div class="global-header-ohsucb">
        <a href="https://www.ohsu.edu/xd/education/schools/school-of-medicine/departments/computational-biology/"><h2>OHSU Comp Bio</h2></a>
      </div>
    </div>
  </div>


<div class="content section group">

  <div class="sidebar col span_3_of_12">
    <ul class="sidebar-nav">
      
      
        
        <li>
          
          <a href="https://ohsu-comp-bio.github.io/funnel/download/"
             class="sidebar-nav-item "
          >Download</a></li>
          
        
        <li>
          
          <a href="https://ohsu-comp-bio.github.io/funnel/docs/"
             class="sidebar-nav-item "
          >Overview</a></li>
          
        
        <li>
          
          <a href="https://ohsu-comp-bio.github.io/funnel/docs/tasks/"
             class="sidebar-nav-item "
          >Tasks</a></li>
          
        
        <li>
          
          <span class="intermediate">Storage</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/storage/local/"
                   class="sidebar-nav-item "
                >Local</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/storage/aws-s3/"
                   class="sidebar-nav-item "
                >AWS S3</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/storage/google-storage/"
                   class="sidebar-nav-item "
                >Google Storage</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/storage/swift/"
                   class="sidebar-nav-item "
                >OpenStack Swift</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <span class="intermediate">Compute</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/deployment/"
                   class="sidebar-nav-item "
                >Deploying a cluster</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/aws-batch/"
                   class="sidebar-nav-item  active"
                >AWS Batch</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/grid-engine/"
                   class="sidebar-nav-item "
                >Grid Engine</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/htcondor/"
                   class="sidebar-nav-item "
                >HTCondor</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/pbs-torque/"
                   class="sidebar-nav-item "
                >PBS/Torque</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/compute/slurm/"
                   class="sidebar-nav-item "
                >Slurm</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <span class="intermediate">Databases</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/databases/boltdb/"
                   class="sidebar-nav-item "
                >Embedded</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/databases/dynamodb/"
                   class="sidebar-nav-item "
                >DynamoDB</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/databases/elasticsearch/"
                   class="sidebar-nav-item "
                >Elasticsearch</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/databases/mongodb/"
                   class="sidebar-nav-item "
                >MongoDB</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <span class="intermediate">Security</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/security/basic/"
                   class="sidebar-nav-item "
                >Basic Auth</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <span class="intermediate">Development</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/development/developers/"
                   class="sidebar-nav-item "
                >Funnel Developers</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://godoc.org/github.com/ohsu-comp-bio/funnel"
                   class="sidebar-nav-item "
                >Reference</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <span class="intermediate">Events</span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://ohsu-comp-bio.github.io/funnel/docs/events/kafka/"
                   class="sidebar-nav-item "
                >Kafka</a></li>
            </ul>
          </li>
          
          
        
      
    </ul>
  </div>

  <div class="main col span_8_of_12">
    

<h1 id="amazon-batch">Amazon Batch</h1>

<p>This guide covers deploying a Funnel server that leverages <a href="http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Introduction.html">DynamoDB</a> for storage
and <a href="http://docs.aws.amazon.com/batch/latest/userguide/what-is-batch.html">Batch</a> for task execution. You&rsquo;ll need to set up several resources
using either the Funnel CLI or through the provided Amazon web console.</p>

<h3 id="create-required-aws-batch-resources">Create Required AWS Batch Resources</h3>

<p>For Funnel to execute tasks on Batch, you must define a Compute Environment,
Job Queue and Job Definition. Additionally, you must define an IAM role for your
Batch Job Definition. The role provides the job container with permissions to call
the API actions that are specified in its associated policies on your behalf. For
this configuration, these jobs need access to S3 and DynamoDB.</p>

<p>Note, we recommend creating the Job Definition with Funnel by running: <code>funnel aws batch create-job-definition</code>.
Funnel expects the JobDefinition to start a <code>worker</code> with a specific configuration. Only
advanced users should consider making any substantial changes to this Job Definition.</p>

<h3 id="create-resources-with-aws">Create Resources With AWS</h3>

<p>Amazon provides a quick start guide with more information <a href="http://docs.aws.amazon.com/batch/latest/userguide/Batch_GetStarted.html#first-run-step-2">here</a>.</p>

<ul>
<li>Create a Compute Environment - <a href="https://us-west-2.console.aws.amazon.com/batch/home?region=us-west-2#/compute-environments/new">link</a></li>
<li>Create a Job Queue - <a href="https://us-west-2.console.aws.amazon.com/batch/home?region=us-west-2#/queues/new">link</a></li>
<li>Define an EC2ContainerTaskRole with policies for managing access to S3 and DynamoDB - <a href="https://console.aws.amazon.com/iam/home?region=us-west-2#/roles$new?step=permissions&amp;selectedService=EC2ContainerService&amp;selectedUseCase=EC2ContainerTaskRole">link</a></li>
<li>Create a Job Definition - <a href="https://us-west-2.console.aws.amazon.com/batch/home?region=us-west-2#/job-definitions/new">link</a></li>
</ul>

<h3 id="create-resources-with-funnel">Create Resources With Funnel</h3>

<p>Funnel provides a utility to create the resources you will need to get up and running.
You will need to specify the AWS region to create these resources in using the <code>--region</code> flag.</p>

<p><em>Note:</em> this command assumes your environment contains your AWS credentials. These
can be configured with the <code>aws configure</code> command.</p>

<pre><code>$ funnel aws batch create-all-resources

Create a compute environment, job queue and job definition in a specified region

Usage:
  funnel aws batch create-all-resources [flags]

Flags:
      --ComputeEnv.InstanceTypes strings     The instances types that may be launched. You can also choose optimal to pick instance types on the fly that match the demand of your job queues. (default [optimal])
      --ComputeEnv.MaxVCPUs int              The maximum number of EC2 vCPUs that an environment can reach. (default 256)
      --ComputeEnv.MinVCPUs int              The minimum number of EC2 vCPUs that an environment should maintain. (default 0)
      --ComputeEnv.SecurityGroupIds strings  The EC2 security groups that are associated with instances launched in the compute environment. If none are specified all security groups will be used.
      --ComputeEnv.Subnets strings           The VPC subnets into which the compute resources are launched. If none are specified all subnets will be used.
      --ComputeEnv.Name string               The name of the compute environment. (default &quot;funnel-compute-environment&quot;)
      --JobDef.Image string                  The docker image used to start a container. (default &quot;docker.io/ohsucompbio/funnel:latest&quot;)
      --JobDef.JobRoleArn string             The Amazon Resource Name (ARN) of the IAM role that the container can assume for AWS permissions. A role will be created if not provided.
      --JobDef.MemoryMiB int                 The hard limit (in MiB) of memory to present to the container. (default 128)
      --JobDef.Name string                   The name of the job definition. (default &quot;funnel-job-def&quot;)
      --JobDef.VCPUs int                     The number of vCPUs reserved for the container. (default 1)
      --JobQueue.Name string                 The name of the job queue. (default &quot;funnel-job-queue&quot;)
      --JobQueue.Priority int                The priority of the job queue. Priority is determined in descending order. (default 1)
      --config string                        Funnel configuration file
  -h, --help                                 help for create-resources
      --region string                        Region in which to create the Batch resources.
</code></pre>

<h2 id="configuring-the-funnel-server">Configuring the Funnel Server</h2>

<p>Since the tasks and logs are stored in DynamoDB the Funnel server can be turned
on and off without data loss.</p>

<p>Start the server:</p>

<pre><code>funnel server run --config /path/to/config.yaml
</code></pre>

<p>Here is an example of the configuration you would need for the server had you
run <code>funnel aws batch create-all-resources --region us-west-2</code>:</p>

<pre><code class="language-YAML">Server:
  Database: &quot;dynamodb&quot;
  Databases:
    Dynamodb:
      TableBasename: &quot;funnel&quot;
      Region: &quot;us-west-2&quot;
      Credentials:
        Key: &quot;&quot;
        Secret: &quot;&quot;

Backend: &quot;aws-batch&quot;
Backends:
  Batch:
    JobDefinition: &quot;funnel-job-def&quot;
    JobQueue: &quot;funnel-job-queue&quot; 
    Region: &quot;us-west-2&quot;
    Credentials:
      Key: &quot;&quot;
      Secret: &quot;&quot;
            
Worker:
  TaskReader: &quot;dynamodb&quot;
  TaskReaders:
    Dynamodb:
      TableBasename: &quot;funnel&quot;
      Region: &quot;us-west-2&quot;
      Credentials:
        Key: &quot;&quot;
        Secret: &quot;&quot;
  ActiveEventWriters:
    - &quot;log&quot;
    - &quot;dynamodb&quot;
  EventWriters:
    Dynamodb:
      TableBasename: &quot;funnel&quot;
      Region: &quot;us-west-2&quot;
      Credentials:
        Key: &quot;&quot;
        Secret: &quot;&quot;
  Storage:
    S3:
      Credentials:
        Key: &quot;&quot;
        Secret: &quot;&quot;
</code></pre>

<h3 id="known-issues">Known issues</h3>

<p>Disk size and host volume management extra setup. The <code>Task.Resources.DiskGb</code> field does not have any effect. See <a href="https://github.com/ohsu-comp-bio/funnel/issues/317">issue 317</a>.</p>

  </div>

</div>
</body>
</html>
